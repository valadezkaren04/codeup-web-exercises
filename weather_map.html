<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather</title>
    <!--***MAPBOX API***-->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css' rel='stylesheet'/>
    <!--****************-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <link rel="stylesheet" href="css/weather-map.css">
    <!--****************-->
</head>
<body>
<h2 class="text-center">Weather Forecast</h2>
<div id="container">
    <div id="weatherDisplay" class="d-flex justify-content-center"></div>
</div>
<div id='map' style='width: 600px; height: 400px;'></div>
<div>
    <label for="text-input">Search address</label>
    <input type="text" id="text-input">
    <button type="submit" id="btn">Take me there</button>
    <div id="searchWeather"></div>
</div>


<!--****************-->
<script src="js/keys.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="js/mapbox-geocode-utils.js"></script>
<script src='https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js'></script>
<!--****************-->
<script>
    function weatherForecast() {
        //**********shows weather in console and browser**********//
        $.get("http://api.openweathermap.org/data/2.5/onecall", {
            APPID: WEATHER_MAP_TOKEN,
            lat:    32.9756,
            lon:   -96.8900,
            units: "imperial",
            exclude: "minutely"
        }).done(function(resp) {
            console.log('5 day forecast', resp);
            var htmlStr = '';
            for (var i = 0; i < 5; i++) {
                var date = resp.daily[i];
                var displayDate = new Date(date.dt * 1000).toDateString();
                displayDate = displayDate.slice(0, displayDate.length - 4)
                htmlStr += `<div class= "card w-70 m-2 col">`
                htmlStr += '<h6 class="text-center">' + displayDate + "</h6>";
                htmlStr += `<img style='margin: 0 auto' width="100px" src="http://openweathermap.org/img/wn/${resp.daily[i].weather[0].icon}@2x.png\n"/>`
                htmlStr += '<div class="text-center">' + resp.daily[i].weather[0].description + "</div>";
                htmlStr += 'HI: ' + Math.round(resp.daily[i].temp.max) + '&#8457;' + '<br>';
                htmlStr += 'LO: ' + Math.round(resp.daily[i].temp.min) + '&#8457;' +'<br>';
                htmlStr += 'Humidity: ' + resp.daily[i].humidity + '%' + '<br>';
                htmlStr += 'Precipitation: ' + resp.daily[i].pop + '%' + '<br>';
                htmlStr += `</div></div>`
                $('#weatherDisplay').html(htmlStr);
            }
            console.log(resp);
        });
    }
    weatherForecast();

    //**********displays map on page**********//
    mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
    var map = new mapboxgl.Map({
        container: 'map'
    });

    map.setStyle("mapbox://styles/mapbox/streets-v11");
    map.setZoom(9);
    map.setCenter([-96.8900, 32.9756]);

    console.log(map.getCenter());

    map.addControl(new mapboxgl.NavigationControl());

    //**********popup on map*********//
    var latLng = {};

    var popup = new mapboxgl.Popup()
        .setHTML("")
        .setMaxWidth("300px");

    //**********marker on map**********//
    var marker = new mapboxgl.Marker({
        color: 'purple',
        draggable: true
    })
        .setLngLat([-96.8900, 32.9756])
        .addTo(map)
        .setPopup(popup);

    marker.on('dragend', function (){
        newCoordinates = marker.getLngLat().toArray();
        $("#searchWeather").html("");
        weatherForecast();
        updateTheInfo();
    });

    function updateTheInfo() {
        var lngLat = marker.getLngLat();
        latLngObj = {lat: lngLat.lat, lng: lngLat.lng};
        reverseGeocode(latLngObj, MAPBOX_ACCESS_TOKEN).then(function (results) {
            var arr = results.features;
            var place = arr.find(x => x.id.includes('place') === true);
            marker._popup._content.innerHTML = '<h4>' + place.place_name + '</h4>';
            // console.log(results);
        })
    }

    //**********search bar**********//
    var userInput = "";
    $("#btn").click(function() {
        userInput = $('#text-input').val();
        console.log(userInput);
        markerToNewPlace();
    })

    function markerToNewPlace() {
        geocode(userInput, MAPBOX_ACCESS_TOKEN).then(function (results){
            marker.setLngLat(results);
            // console.log(results);
            newCoordinates = marker.getLngLat().toArray().reverse();
            updateTheInfo();
            weatherForecast();
            map.flyTo({
                center: results,
                zoom: 9,
                speed: 0.5
            });
        });
    }


</script>

<!--****************-->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>
<!--****************-->
</body>
</html>
